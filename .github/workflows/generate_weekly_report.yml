# .github/workflows/generate_weekly_report.yml

name: Generate Weekly Report

# 手動実行のみ (cron は不要)
on:
  workflow_dispatch:
    inputs:
      week_start:
        description: '週の開始曜日を選択してください (例: monday, tuesday, …)'
        required: true
        default: 'monday'
      target:
        description: 'どの週を生成するか (last_week / this_week)'
        required: true
        default: 'last_week'

# GitHub Actions がコミット & プッシュするための権限
permissions:
  contents: write

jobs:
  build-weekly-report:
    runs-on: ubuntu-latest

    steps:
      # 1. リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 週の範囲 (START_DATE, END_DATE) を計算する
      - name: Calculate week range
        id: date_calc
        run: |
          WEEK_START="${{ github.event.inputs.week_start }}"  # monday, tuesday, …
          TARGET="${{ github.event.inputs.target }}"          # last_week or this_week

          if [ "$TARGET" = "last_week" ]; then
            END_DATE=$(date -d "last $WEEK_START" +'%Y/%m/%d')
          else
            END_DATE=$(date -d "this $WEEK_START" +'%Y/%m/%d')
          fi

          START_DATE=$(date -d "$END_DATE - 6 days" +'%Y/%m/%d')

          # 出力形式は 'YYYY/MM/DD'
          echo "START_DATE=$START_DATE" >> $GITHUB_OUTPUT
          echo "END_DATE=$END_DATE" >> $GITHUB_OUTPUT

      # 3. merged フォルダを作成 (マージした中間ファイル置き場)
      - name: Create merged directory
        run: |
          mkdir -p merged

      # 4. 日報ファイルをマージする
      - name: Merge daily reports
        id: merge
        run: |
          START="${{ steps.date_calc.outputs.START_DATE }}"
          END="${{ steps.date_calc.outputs.END_DATE }}"

          # YYYY/MM/DD → YYYY-MM-DD に変換 (ファイル名用)
          SFMT_START=$(echo "$START" | sed 's/\//-/g')
          SFMT_END=$(echo "$END" | sed 's/\//-/g')

          # merged/weekly_<開始>_to_<終了>.md に出力
          MERGED_FILE="merged/weekly_${SFMT_START}_to_${SFMT_END}.md"
          echo "" > "$MERGED_FILE"

          CUR="$START"
          COUNT=0

          # START から END まで 1 日ずつループ
          while [ "$(date -d "$CUR" +'%Y/%m/%d')" != "$(date -d "$END + 1 day" +'%Y/%m/%d')" ]; do
            Y=$(date -d "$CUR" +'%Y')
            M=$(date -d "$CUR" +'%m')
            D=$(date -d "$CUR" +'%d')
            PATH_DAILY="${Y}/${M}/${D}.md"

            if [ -f "$PATH_DAILY" ]; then
              echo -e "\n\n---\n# ${Y}/${M}/${D}\n" >> "$MERGED_FILE"
              cat "$PATH_DAILY" >> "$MERGED_FILE"
              COUNT=$((COUNT + 1))
            fi

            CUR=$(date -d "$CUR + 1 day" +'%Y/%m/%d')
          done

          # 日報が 1 件も見つからなかったらエラー終了
          if [ "$COUNT" -eq 0 ]; then
            echo "Error: No daily reports found between $START and $END" >&2
            exit 1
          fi

          echo "Merged $COUNT daily report(s) into $MERGED_FILE"
          echo "MERGED_FILE=$MERGED_FILE" >> $GITHUB_OUTPUT

      # 5. プロンプトファイルを作成 (weekly_report_template.md → merged/prompt_weekly_*.md)
      - name: Create prompt file
        id: prompt
        run: |
          START="${{ steps.date_calc.outputs.START_DATE }}"
          END="${{ steps.date_calc.outputs.END_DATE }}"
          MERGED_FILE="${{ steps.merge.outputs.MERGED_FILE }}"

          # YYYY/MM/DD → YYYY-MM-DD
          SFMT_START=$(echo "$START" | sed 's/\//-/g')
          SFMT_END=$(echo "$END" | sed 's/\//-/g')

          TEMPLATE="weekly_report_template.md"
          PROMPT_FILE="merged/prompt_weekly_${SFMT_START}_to_${SFMT_END}.md"

          # ① テンプレート中の {{WEEK_START}}, {{WEEK_END}} を置換
          sed \
            -e "s/{{WEEK_START}}/${START//\//\\/}/g" \
            -e "s/{{WEEK_END}}/${END//\//\\/}/g" \
            "$TEMPLATE" > "${PROMPT_FILE}.tmp"

          # ② {{MERGED_CONTENT}} をマージ済み日報の中身に差し込む
          awk -v merged="$(sed 's/\\/\\\\/g; s/&/\\&/g; s/$/\\/' "$MERGED_FILE")" \
            '{ if ($0 ~ /{{MERGED_CONTENT}}/) { print merged } else { print } }' \
            "${PROMPT_FILE}.tmp" > "$PROMPT_FILE"

          rm "${PROMPT_FILE}.tmp"
          echo "PROMPT_FILE=$PROMPT_FILE" >> $GITHUB_OUTPUT

      # 6. Gemini API を呼び出して週報を生成 (月報ワークフローと同じ方式)
      - name: Call Gemini API for weekly report
        id: ai
        run: |
          PROMPT_FILE="${{ steps.prompt.outputs.PROMPT_FILE }}"

          # テンプレート内で作成した PROMPT を一行文字列にまとめる
          PROMPT=$(sed ':a;N;$!ba;s/\n/\\n/g' "$PROMPT_FILE")

          # generate_monthly_report.yml で使っている Gemini 呼び出し方式をそのまま踏襲
          # （Google Generative Language API のエンドポイントを使用）
          RESPONSE=$(curl -s -X POST \
            "https://generativelanguage.googleapis.com/v1beta2/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{
              "contents": [{
                "parts": [{ "text": "'"${PROMPT}"'" }]
              }]
            }' \
            | jq -r '.candidates[0].content.parts[0].text')

          # レスポンスが空であれば失敗
          if [ -z "$RESPONSE" ]; then
            echo "ERROR: Failed to generate weekly report from Gemini API." >&2
            exit 1
          fi

          # GENERATED_CONTENT として出力 (改行を含めて扱う)
          echo "GENERATED_CONTENT<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 7. 週報ファイルを作成して書き込む
      - name: Create weekly report file
        id: write
        run: |
          mkdir -p weekly_report

          SFMT_START=$(echo "${{ steps.date_calc.outputs.START_DATE }}" | sed 's/\//-/g')
          SFMT_END=$(echo "${{ steps.date_calc.outputs.END_DATE }}" | sed 's/\//-/g')

          # 例: weekly_report/2025-05-26to2025-06-01.md
          WEEKLY_FILE="weekly_report/${SFMT_START}to${SFMT_END}.md"

          # GitHub Actions の出力に保存した GENERATED_CONTENT を書き込む
          echo "${{ steps.ai.outputs.GENERATED_CONTENT }}" > "$WEEKLY_FILE"
          echo "WEEKLY_FILE=$WEEKLY_FILE" >> $GITHUB_OUTPUT

      # 8. git コミット & プッシュ
      - name: Commit and push weekly report
        run: |
          # GitHub Actions ランナーのユーザ情報を設定
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          SFMT_START=$(echo "${{ steps.date_calc.outputs.START_DATE }}" | sed 's/\//-/g')
          SFMT_END=$(echo "${{ steps.date_calc.outputs.END_DATE }}" | sed 's/\//-/g')
          FILE_PATH="weekly_report/${SFMT_START}to${SFMT_END}.md"

          # 変更をステージング
          git add "$FILE_PATH"

          # 新規作成または更新があればコミット
          git diff --cached --quiet || git commit -m "Add weekly report: ${START} to ${END}"

          # main ブランチへプッシュ
          git push origin main
